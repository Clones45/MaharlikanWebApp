<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Withdrawal Requests ‚Äî Maharlikan AssuredLife</title>

  <link rel="stylesheet" href="styles.css" />

  <style>
    #withdrawals-page {
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #05070b;
      color: #f9fafb;
      min-height: 100vh;
    }

    #withdrawals-page .card {
      box-shadow: 0 12px 30px rgba(0, 0, 0, .4);
      border-radius: 18px;
      background: #0b1220;
      border: 1px solid rgba(148, 163, 184, .4);
      max-width: 1120px;
      margin: 0 auto;
    }

    #withdrawals-page .content {
      padding: 18px 20px 20px;
    }

    #withdrawals-page .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    #withdrawals-page .title-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #withdrawals-page .title {
      font-weight: 700;
      font-size: 20px;
      color: #e5e7eb;
    }

    #withdrawals-page .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .btn {
      border-radius: 8px;
      padding: 6px 12px;
      border: 0;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-main {
      background: #16a34a;
      color: #fff;
    }

    .btn-refresh {
      background: #0b4d87;
      color: #fff;
    }

    .btn-approve {
      background: #16a34a;
      color: #fff;
    }

    .btn-reject {
      background: #dc2626;
      color: #fff;
    }

    .btn-disabled {
      background: #4b5563;
      color: #e5e7eb;
      cursor: default;
      opacity: .7;
    }

    .btn:hover:not(.btn-disabled) {
      filter: brightness(1.05);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-pill {
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .status-pending {
      background: rgba(251, 191, 36, .15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, .4);
    }

    .status-approved {
      background: rgba(34, 197, 94, .12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, .5);
    }

    .status-rejected {
      background: rgba(248, 113, 113, .15);
      color: #f87171;
      border: 1px solid rgba(248, 113, 113, .5);
    }

    .table-wrap {
      max-height: 520px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, .7);
      background: #020617;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: #e5e7eb;
    }

    th,
    td {
      border-bottom: 1px solid rgba(31, 41, 55, .9);
      padding: 8px 10px;
      text-align: left;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #9ca3af;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:nth-child(odd) {
      background: #020617;
    }

    tbody tr:hover {
      background: #111827;
    }

    .right {
      text-align: right;
    }

    .muted {
      color: #9ca3af;
      font-size: 12px;
    }

    .footer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    a.btn-link {
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 8px;
      background: #0b4d87;
      color: #fff;
      font-size: 13px;
    }

    @media print {

      .toolbar,
      .footer-actions {
        display: none !important;
      }

      body {
        background: #fff;
      }

      #withdrawals-page {
        padding: 0;
      }

      #withdrawals-page .card {
        box-shadow: none;
        border: none;
        border-radius: 0;
        background: #fff;
      }

      table {
        color: #111827;
      }
    }
  </style>

  <!-- Supabase CDN (same as Collections page) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SB_URL = "https://agyueadcymdopgihtckc.supabase.co";
    window.__SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFneXVlYWRjeW1kb3BnaWh0Y2tjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzA2NjYsImV4cCI6MjA3NDkwNjY2Nn0.EBYfJ9RTkeGLQptG3uWaOsFMIz9DySu3uhaOlzgeeMw";
    // üõë CRITICAL: Use dummy storage to prevent clearing main window's localStorage
    const dummyStorage = {
      getItem: () => null,
      setItem: () => { },
      removeItem: () => { },
    };

    window.SB = window.SB || supabase.createClient(window.__SB_URL, window.__SB_KEY, {
      auth: {
        persistSession: false,
        autoRefreshToken: true,
        detectSessionInUrl: false,
        storage: dummyStorage
      }
    });
  </script>

  <script type="module">
    const sb = window.SB;
    const tbody = document.getElementById("withdrawalsBody");
    const refreshBtn = document.getElementById("refreshBtn");
    const homeBtn = document.getElementById("homeBtn");
    const pendingBadge = document.getElementById("pendingCount");

    refreshBtn.addEventListener("click", loadWithdrawals);
    homeBtn.addEventListener("click", () => {
      // Adjust path if your main menu HTML is different
      window.location.href = "../renderer/index.html";
    });

    async function loadWithdrawals() {
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Loading withdrawal requests‚Ä¶</td></tr>`;

      // ‚úÖ FIXED: Select * and join agents, order by created_at
      const { data, error } = await sb
        .from("withdrawal_requests")
        .select(`
          *,
          agents:agent_id ( firstname, lastname, user_id )
        `)
        .order("created_at", { ascending: false });

      if (error) {
        console.log("‚ùå Withdrawal query error", error);
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Error loading withdrawal requests.</td></tr>`;
        pendingBadge.textContent = "0";
        return;
      }

      console.log("‚úÖ Withdrawal query success", data);
      renderWithdrawals(data || []);
    }

    function renderWithdrawals(list) {
      tbody.innerHTML = "";

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No withdrawal requests yet.</td></tr>`;
        pendingBadge.textContent = "0";
        return;
      }

      let pending = 0;

      list.forEach(req => {
        if (req.status === "pending") pending++;

        const tr = document.createElement("tr");
        const agentName = req.agents
          ? `${req.agents.firstname} ${req.agents.lastname}`
          : `Agent #${req.agent_id}`;

        let statusClass = "status-pending";
        if (req.status === "approved") statusClass = "status-approved";
        if (req.status === "rejected") statusClass = "status-rejected";

        const canAct = req.status === "pending";

        tr.innerHTML = `
          <td>${req.id}</td>
          <td>${agentName}</td>
          <td class="right">‚Ç±${Number(req.amount || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</td>
          <td>${req.period_month}/${req.period_year}</td>
          <td>${new Date(req.created_at).toLocaleString()}</td>
          <td>
            <span class="status-pill ${statusClass}">${req.status}</span>
          </td>
          <td>
            ${canAct ? `
              <button class="btn btn-approve" data-action="approve" data-id="${req.id}">Approve</button>
              <button class="btn btn-reject" data-action="reject" data-id="${req.id}">Reject</button>
            ` : `
              <button class="btn btn-disabled" disabled>Done</button>
            `}
          </td>
        `;

        tbody.appendChild(tr);
      });

      pendingBadge.textContent = String(pending);

      // Attach button events after render
      tbody.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const action = btn.dataset.action;
          const id = Number(btn.dataset.id);
          const newStatus = action === "approve" ? "approved" : "rejected";
          const row = list.find(r => r.id === id);

          if (!row) return;

          const confirmText = action === "approve"
            ? `Approve withdrawal of ‚Ç±${row.amount} for ${row.period_month}/${row.period_year}?`
            : `Reject withdrawal of ‚Ç±${row.amount} for ${row.period_month}/${row.period_year}?`;

          if (!confirm(confirmText)) return;

          await updateWithdrawalStatus(row, newStatus);
        });
      });
    }

    async function updateWithdrawalStatus(row, newStatus) {
      // 1) Update withdrawal_requests status
      const { error: updError } = await sb
        .from("withdrawal_requests")
        .update({
          status: newStatus,
          updated_at: new Date().toISOString()
        })
        .eq("id", row.id);

      if (updError) {
        console.error("‚ùå status update error", updError);
        alert("Failed to update status. Please try again.");
        return;
      }

      // 2) Insert notification to agent (if we have user_id)
      try {
        let agent = row.agents;
        if (!agent || !agent.user_id) {
          const { data } = await sb
            .from("agents")
            .select("firstname, lastname, user_id")
            .eq("id", row.agent_id)
            .single();
          agent = data;
        }

        if (agent && agent.user_id) {
          let title, message;
          if (newStatus === "approved") {
            title = "Withdrawal Approved";
            message = `Your withdrawal request for ‚Ç±${row.amount} (period ${row.period_month}/${row.period_year}) has been approved.`;
          } else {
            title = "Withdrawal Rejected";
            message = `Your withdrawal request for ‚Ç±${row.amount} (period ${row.period_month}/${row.period_year}) has been rejected. Please contact admin for details.`;
          }

          await sb.from("notifications").insert({
            title,
            message,
            type: "withdrawal_status",
            is_read: false,
            target_role: "agent",
            user_id: agent.user_id,
            created_at: new Date().toISOString()
          });
        }
      } catch (err) {
        console.warn("‚ö† notification insert failed (non-blocking)", err);
      }

      alert(`Status updated to "${newStatus}".`);
      await loadWithdrawals();
    }

    // üîî Realtime: refresh list on new requests
    sb.channel("withdrawals-live-admin")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "withdrawal_requests" },
        () => loadWithdrawals()
      )
      .subscribe();

    // Initial load
    loadWithdrawals();
  </script>
</head>

<body>
  <div id="withdrawals-page" class="page">
    <div class="card">
      <div class="content">
        <div class="header">
          <div class="title-wrap">
            <div class="title">Withdrawal Requests</div>
            <div class="subtitle">
              Manage agents‚Äô commission withdrawals. Pending:
              <span id="pendingCount" style="font-weight:600; color:#fbbf24;">0</span>
            </div>
          </div>

          <div class="header-actions">
            <button id="homeBtn" class="btn btn-main">üè† Home</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="muted">
            Click <b>Approve</b> to release commission, or <b>Reject</b> to deny the request.
          </div>
          <div>
            <button id="refreshBtn" class="btn btn-refresh">üîÑ Refresh</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Agent</th>
                <th class="right">Amount</th>
                <th>Period</th>
                <th>Requested At</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="withdrawalsBody">
              <tr>
                <td colspan="8" class="muted">Loading withdrawal requests‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="footer-actions">
          <a href="../renderer/index.html" class="btn-link">‚¨Ö Back to Menu</a>
        </div>
      </div>
    </div>
  </div>
</body>

</html>